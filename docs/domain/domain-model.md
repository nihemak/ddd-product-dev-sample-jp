# ドメインモデル図

このドキュメントは、プロジェクトのドメインモデルを Mermaid のクラス図を用いて視覚的に表現します。
ユビキタス言語に基づき、主要なエンティティ、値オブジェクト、およびそれらの関係性を示します。

**注意:** 現在、このドキュメントには「記念日プレゼント予約・配送サービス」のドメインモデル図と、初期サンプル実装に由来するドメインモデル図が混在しています。将来的にはソースコードのリファクタリングに伴い、サンプル由来のモデル図は削除される予定です。

## 記念日プレゼント予約・配送サービス ドメインモデル図

```mermaid
classDiagram
    direction TB

    class プレゼント予約状態 { <<enumeration>> }
    %% 状態Enumは概念として残すが、型は分割

    class プレゼント予約ベース {
        <<Abstract>>
        予約ID
        依頼者ID
        届け先ID
        記念日
        メッセージ内容
        ラッピングオプション
        配送希望日時
        合計金額
        支払いID
        %% 共通の振る舞い (変更・キャンセルなど。ただし遷移先は具象型になる)
        予約内容を変更する()
        %% Result<Self, DomainError>
        予約をキャンセルする()
        %% Result<キャンセル済み..., DomainError>
    }

    %% --- 発送代行 状態型 --- 
    class 予約受付済み発送代行予約型 {
        <<予約受付済み_発送代行>>
        +発送代行プレゼント情報 : String
        +発送準備を開始する() Result<発送準備中発送代行予約型, DomainError>
    }
    class 発送準備中発送代行予約型 {
        <<発送準備中_発送代行>>
        +発送代行プレゼント情報 : String
        +発送を完了する() Result<発送済み発送代行予約型, DomainError>
    }
    class 発送済み発送代行予約型 {
        <<発送済み_発送代行>>
        +発送代行プレゼント情報 : String
        +配送伝票番号
        +配送完了を記録する() Result<配送完了発送代行予約型, DomainError>
    }
    class 配送完了発送代行予約型 {
        <<配送完了_発送代行>>
        +発送代行プレゼント情報 : String
        +配送伝票番号
        +配送完了日時
    }
    class キャンセル済み発送代行予約型 {
        <<キャンセル済み_発送代行>>
        +発送代行プレゼント情報 : String
        +キャンセル理由
        +キャンセル日時
    }

    プレゼント予約ベース <|-- 予約受付済み発送代行予約型
    プレゼント予約ベース <|-- 発送準備中発送代行予約型
    プレゼント予約ベース <|-- 発送済み発送代行予約型
    プレゼント予約ベース <|-- 配送完了発送代行予約型
    プレゼント予約ベース <|-- キャンセル済み発送代行予約型

    予約受付済み発送代行予約型 --> 発送準備中発送代行予約型 : 発送準備を開始する()
    発送準備中発送代行予約型 --> 発送済み発送代行予約型 : 発送を完了する()
    発送済み発送代行予約型 --> 配送完了発送代行予約型 : 配送完了を記録する()
    予約受付済み発送代行予約型 --> キャンセル済み発送代行予約型 : 予約をキャンセルする()
    発送準備中発送代行予約型 --> キャンセル済み発送代行予約型 : 予約をキャンセルする()

    %% --- プレゼント手配 状態型 --- (MVP以降だが構造を示す)
    class 予約受付済み手配予約型 {
        <<予約受付済み_手配>>
        +手配商品リスト : List<商品ID>
        +発送準備を開始する()
        %% Result<発送準備中手配予約型, DomainError>
    }
    class 発送準備中手配予約型 { <<発送準備中_手配>> ... }
    class 発送済み手配予約型 { <<発送済み_手配>> ... }
    class 配送完了手配予約型 { <<配送完了_手配>> ... }
    class キャンセル済み手配予約型 { <<キャンセル済み_手配>> ... }

    プレゼント予約ベース <|-- 予約受付済み手配予約型
    %% ... 他の手配状態型もベースを継承 ...

    予約受付済み手配予約型 "1" -- "1..*" 商品ID : 手配商品リスト
    %% ... 他の手配状態型も商品IDリストを持つ ...

    %% --- 他エンティティ・VO --- 
    class 届け先
    class ユーザーアカウント
    class 商品
    class 支払い
    class 予約ID { <<ValueObject>> }
    class 届け先ID { <<ValueObject>> }
    class ユーザーID { <<ValueObject>> }
    class 商品ID { <<ValueObject>> }
    class 支払いID { <<ValueObject>> }
    class 記念日 { <<ValueObject>> }
    class 金額 { <<ValueObject>> }

    プレゼント予約ベース "1" *-- "1" 予約ID : id
    プレゼント予約ベース "1" -- "1" ユーザーID : 依頼者ID
    プレゼント予約ベース "1" -- "1" 届け先ID : 届け先ID
    プレゼント予約ベース "1" -- "1" 記念日 : 記念日
    プレゼント予約ベース "1" -- "1" 支払いID : 支払いID

    note for プレゼント予約ベース "予約タイプ(発送代行/手配)と状態に応じた具象型が存在"
    note for 予約受付済み発送代行予約型 "発送代行固有のプレゼント情報(String)を持つ"
    note for 予約受付済み手配予約型 "プレゼント手配固有の商品IDリストを持つ"
    note for 記念日 "ValueObjectとして日付を持つ。生成/変更時にリードタイム検証が必要"
    note for メッセージ内容 "ValueObjectとしてテキスト(最大200文字)を持つ。ベースに定義"

```

上記の図は、記念日プレゼント予約・配送サービスのドメインモデルを、「状態を型で表現する」アプローチ (ADR 0003) に基づき、**さらに予約タイプ（発送代行/手配）ごとにも型を分割**して示しています。
共通のデータや振る舞いは `プレゼント予約ベース` に持たせ、予約タイプと状態に固有のデータ（例: `発送代行プレゼント情報` vs `手配商品リスト`）や遷移ロジックは、それぞれの具象型（例: `予約受付済み発送代行予約型`, `予約受付済み手配予約型`）が持ちます。

---

## サンプル実装由来のドメインモデル図 (既存コードとの対応用)

以下のモデル図は、初期のサンプル実装 (`src/`) に基づくものです。
**注意:** これは現在の記念日プレゼント予約・配送サービスのドメインモデルとは直接対応しません。

```mermaid
classDiagram
    class 注文 {
        +注文ID
        +List<商品ID> 商品リスト
        +u32 合計金額
        +注文状態 状態
        +発送準備中へ変更() Result<注文, DomainError>
        +発送済みへ変更() Result<注文, DomainError>
        +注文キャンセル() Result<注文, DomainError>
    }
    class 商品 {
        +商品ID
        +String 名前
        +u32 価格
    }
    class 注文ID {
      <<ValueObject>>
      +Uuid value
    }
    class 商品ID {
      <<ValueObject>>
      +Uuid value
    }
    class 注文状態 {
      <<Enumeration>>
      受付済み
      発送準備中
      発送済み
      キャンセル済み
    }
    class DomainError {
      <<Enumeration>>
      注文商品空エラー
      不正な状態遷移エラー
      注文NotFound
      商品NotFound
      価格計算オーバーフロー
    }

    注文 "1" *-- "1" 注文ID : id
    注文 "1" *-- "1..*" 商品ID : 商品リスト
    注文 "1" -- "1" 注文状態 : 状態
    商品 "1" *-- "1" 商品ID : id

    note for 注文 "注文は集約ルート"
```

上記の図は、サンプル実装における主要なエンティティ (`注文`, `商品`)、値オブジェクト (`注文ID`, `商品ID`, `注文状態`)、およびそれらの基本的な関連性を示しています。
`注文`が集約ルート（Aggregate Root）であり、`注文状態`の遷移ロジックの一部をメソッドとして持っています。
`DomainError`はサンプル実装のドメイン層で発生しうるエラーの種類を示します。
