# ドメインモデル図

このドキュメントは、プロジェクトのドメインモデルを Mermaid のクラス図を用いて視覚的に表現します。
ユビキタス言語に基づき、主要なエンティティ、値オブジェクト、およびそれらの関係性を示します。

**注意:** 現在、このドキュメントには「記念日プレゼント予約・配送サービス」のドメインモデル図と、初期サンプル実装に由来するドメインモデル図が混在しています。将来的にはソースコードのリファクタリングに伴い、サンプル由来のモデル図は削除される予定です。

## 記念日プレゼント予約・配送サービス ドメインモデル図

```mermaid
classDiagram
    direction TB

    class プレゼント予約状態 {
        <<enumeration>>
        予約受付済み(予約受付済みプレゼント予約型)
        発送準備中(発送準備中プレゼント予約型)
        発送済み(発送済みプレゼント予約型)
        配送完了(配送完了プレゼント予約型)
        キャンセル済み(キャンセル済みプレゼント予約型)
    }

    class プレゼント予約ベース {
        <<Abstract>>
        予約ID
        ユーザーID 依頼者ID
        届け先ID
        記念日
        メッセージ内容
        ラッピングオプション
        配送希望日時
        金額 合計金額
        支払いID
        予約内容を変更する() Result<Self, DomainError>
        予約をキャンセルする() Result<キャンセル済みプレゼント予約型, DomainError>
    }

    class 予約受付済みプレゼント予約型 {
        <<予約受付済み>>
        +発送代行プレゼント情報 or List<商品ID> 手配商品リスト
        +発送準備を開始する() Result<発送準備中プレゼント予約型, DomainError>
    }

    class 発送準備中プレゼント予約型 {
        <<発送準備中>>
        +発送代行プレゼント情報 or List<商品ID> 手配商品リスト
        +発送を完了する() Result<発送済みプレゼント予約型, DomainError>
        + (梱包担当者ID など、この状態固有のデータ)
    }

    class 発送済みプレゼント予約型 {
        <<発送済み>>
        +発送代行プレゼント情報 or List<商品ID> 手配商品リスト
        +配送伝票番号
        +配送完了を記録する() Result<配送完了プレゼント予約型, DomainError>
    }

    class 配送完了プレゼント予約型 {
        <<配送完了>>
        +発送代行プレゼント情報 or List<商品ID> 手配商品リスト
        +配送伝票番号
        +配送完了日時
    }

    class キャンセル済みプレゼント予約型 {
        <<キャンセル済み>>
        +キャンセル理由
        +キャンセル日時
    }

    プレゼント予約ベース <|-- 予約受付済みプレゼント予約型
    プレゼント予約ベース <|-- 発送準備中プレゼント予約型
    プレゼント予約ベース <|-- 発送済みプレゼント予約型
    プレゼント予約ベース <|-- 配送完了プレゼント予約型
    プレゼント予約ベース <|-- キャンセル済みプレゼント予約型

    予約受付済みプレゼント予約型 --> 発送準備中プレゼント予約型 : 発送準備を開始する()
    発送準備中プレゼント予約型 --> 発送済みプレゼント予約型 : 発送を完了する()
    発送済みプレゼント予約型 --> 配送完了プレゼント予約型 : 配送完了を記録する()
    予約受付済みプレゼント予約型 --> キャンセル済みプレゼント予約型 : 予約をキャンセルする()
    発送準備中プレゼント予約型 --> キャンセル済みプレゼント予約型 : 予約をキャンセルする()

    %% 他のエンティティ・値オブジェクト (一部省略、関連のみ表示)
    class 届け先
    class ユーザーアカウント
    class 商品
    class 支払い
    class 予約ID { <<ValueObject>> }
    class 届け先ID { <<ValueObject>> }
    class ユーザーID { <<ValueObject>> }
    class 商品ID { <<ValueObject>> }
    class 支払いID { <<ValueObject>> }
    class 記念日 { <<ValueObject>> }
    class 金額 { <<ValueObject>> }

    プレゼント予約ベース "1" *-- "1" 予約ID : id
    プレゼント予約ベース "1" -- "1" ユーザーID : 依頼者
    プレゼント予約ベース "1" -- "1" 届け先ID : 届け先
    プレゼント予約ベース "1" -- "1" 記念日 : 記念日
    プレゼント予約ベース "1" -- "1" 支払いID : 支払い
    予約受付済みプレゼント予約型 "1" -- "0..*" 商品ID : 手配商品リスト
    発送準備中プレゼント予約型 "1" -- "0..*" 商品ID : 手配商品リスト
    発送済みプレゼント予約型 "1" -- "0..*" 商品ID : 手配商品リスト
    配送完了プレゼント予約型 "1" -- "0..*" 商品ID : 手配商品リスト

    note for プレゼント予約状態 "プレゼント予約の状態をEnumと対応する型で表現 (ADR 0003)"
    note for プレゼント予約ベース "各状態に共通のデータと振る舞いを定義"

```

上記の図は、記念日プレゼント予約・配送サービスのドメインモデルを、「状態を型で表現する」アプローチ (ADR 0003) に基づいて示しています。
`プレゼント予約状態` enum が予約全体のライフサイクルを表し、各状態（`予約受付済み`, `発送準備中` など）に対応する具体的な型（`予約受付済みプレゼント予約型`, `発送準備中プレゼント予約型` など）が存在します。
共通のデータや振る舞いは `プレゼント予約ベース` (抽象クラスまたはトレイトとして表現) に持たせ、状態固有のデータや遷移ロジックは各状態の型が持ちます。
状態遷移は、特定の状態の型から別の状態の型への変換関数（図中の矢印とメソッド名）として表現されます。

---

## サンプル実装由来のドメインモデル図 (既存コードとの対応用)

以下のモデル図は、初期のサンプル実装 (`src/`) に基づくものです。
**注意:** これは現在の記念日プレゼント予約・配送サービスのドメインモデルとは直接対応しません。

```mermaid
classDiagram
    class 注文 {
        +注文ID
        +List<商品ID> 商品リスト
        +u32 合計金額
        +注文状態 状態
        +発送準備中へ変更() Result<注文, DomainError>
        +発送済みへ変更() Result<注文, DomainError>
        +注文キャンセル() Result<注文, DomainError>
    }
    class 商品 {
        +商品ID
        +String 名前
        +u32 価格
    }
    class 注文ID {
      <<ValueObject>>
      +Uuid value
    }
    class 商品ID {
      <<ValueObject>>
      +Uuid value
    }
    class 注文状態 {
      <<Enumeration>>
      受付済み
      発送準備中
      発送済み
      キャンセル済み
    }
    class DomainError {
      <<Enumeration>>
      注文商品空エラー
      不正な状態遷移エラー
      注文NotFound
      商品NotFound
      価格計算オーバーフロー
    }

    注文 "1" *-- "1" 注文ID : id
    注文 "1" *-- "1..*" 商品ID : 商品リスト
    注文 "1" -- "1" 注文状態 : 状態
    商品 "1" *-- "1" 商品ID : id

    note for 注文 "注文は集約ルート"
```

上記の図は、サンプル実装における主要なエンティティ (`注文`, `商品`)、値オブジェクト (`注文ID`, `商品ID`, `注文状態`)、およびそれらの基本的な関連性を示しています。
`注文`が集約ルート（Aggregate Root）であり、`注文状態`の遷移ロジックの一部をメソッドとして持っています。
`DomainError`はサンプル実装のドメイン層で発生しうるエラーの種類を示します。
