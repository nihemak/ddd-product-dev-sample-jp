# ADR 0016: ローカル開発環境と認証戦略

*   **Status**: Accepted
*   **Date**: 2025-04-22 (Updated: 2025-05-04)

## Context and Problem Statement

プロダクト開発の初期段階において、開発の速度、効率性、テストの容易性を最大化するための環境戦略を定める必要がある。
特に、外部サービス（クラウドDB、外部IdPなど）への依存度をどのように管理し、ローカルでの開発体験とCI/CDプロセスを最適化するかが課題となる。
また、認証・認可機能は多くの機能の前提となるが、初期段階で外部IdP（例: Auth0）を導入すると、環境設定の複雑性が増し、ローカルでの独立した動作が困難になる可能性がある。
**加えて、複数の開発者（またはAIペアプログラマー）が関わる場合、各々のローカル環境差異による問題を最小限に抑え、一貫した開発・実行環境を提供する必要がある。**

## Decision Drivers

*   **開発効率:** ローカル環境での迅速な起動、ビルド、テスト実行。
*   **テスト容易性:** ローカルおよびCI環境での自動テスト（特に結合テスト）の実行しやすさ。
*   **環境構築の簡便性:** 新しい開発者のオンボーディングや環境再現の容易さ。
*   **早期の基本機能疎通:** 最小限の依存で主要な機能連携を確認できること。
*   **コスト:** 外部サービスの利用コスト（特に開発・テスト段階）。
*   **将来の拡張性:** クラウド環境への移行や外部サービス連携を妨げないこと。

## Considered Options

1.  **ローカル完結 + 段階的認証:**
    *   開発は Docker Compose を用いたローカル環境を主とする。
    *   ローカル環境は外部サービス（クラウドDB、外部IdP）に依存せず動作可能とする。
    *   認証・認可は、まずローカル完結型（例: DBにハッシュ化パスワード保存）で実装する。
    *   Auth0等の外部IdP連携は、基本機能実装後、必要に応じて後続フェーズで導入または切り替えを検討する。
    *   クラウド環境（テスト/ステージング/本番）は別途構築し、ローカルでの動作確認後にデプロイする。
    *   Pros: 開発/テストが高速かつ容易。環境構築がシンプル。早期に認証を含む基本機能を確認可能。CIでのテストが容易。
    *   Cons: 本番（クラウド）環境との差異が生じる。外部IdPへの移行時に手戻りが発生する可能性。ローカル認証方式の実装コスト。
2.  **最初からAuth0連携:**
    *   開発初期から認証・認可にAuth0を利用する。
    *   ローカル開発環境でもAuth0との連携を前提とする。
    *   Pros: 本番に近い環境で開発可能。認証部分の実装コスト削減。豊富なIdP機能を利用可能。
    *   Cons: ローカル環境のAuth0依存度が高まる。環境設定が複雑化。オフライン開発が困難になる可能性。CIでの認証連携テストが複雑化。
3.  **最初からクラウド環境ベース:**
    *   ローカル環境は最小限とし、開発・テストの主体をクラウド上の開発環境（例: Render, Vercel の開発環境）に置く。
    *   Pros: 本番環境との差異が小さい。
    *   Cons: 開発のイテレーション速度が低下する可能性（デプロイ待ちなど）。ローカルでのデバッグが制限される。クラウド利用コストが発生。

## Decision Outcome

**Chosen Option: 1. ローカル完結 + 段階的認証**

*   **開発環境のコンテナ化:** VS Code Dev Containers と Docker Compose を採用し、開発環境（バックエンド、フロントエンド、DB、開発用ツール）全体をコンテナ化する。
    *   これにより、環境構築の再現性を高め、開発者間の環境差異をなくす。
    *   新しい開発者のオンボーディングを容易にする。
*   **ローカル環境の独立性:** 開発効率とテスト容易性を最優先し、ローカルのコンテナ環境は外部サービス（外部IdPなど）に依存せずに動作可能とする。
*   **段階的認証:** 認証はまずDBベースのシンプルな方式で実装し、早期の機能疎通を目指す。
*   **外部IdP連携:** 外部IdP（Auth0）の導入は、必要性が高まった段階で検討・実施する。
*   **CI連携:** CIでのテスト自動化を容易にし、開発初期の基盤を固めることを重視する。

## Consequences

*   **Positive:**
    *   開発サイクルの高速化が期待できる。
    *   CI/CDパイプラインにおける自動テスト（特に認証が関わるもの）の実装が容易になる。
    *   ローカル環境のセットアップが容易になる。
*   **Negative:**
    *   本番環境（クラウド + Auth0）との環境差異を意識する必要がある。
    *   将来Auth0等に移行する際に、認証部分の改修コストが発生する。
    *   ローカル認証方式のセキュリティ対策（ハッシュ化、ソルトなど）を適切に実装する必要がある。

## 追加決定: Docker outside of Docker (DooD) の採用 (2025-05-08)

### 背景
*   開発コンテナ (`develop` サービス) 内から Storybook の起動など、ホストマシンで動作する Docker コンテナを操作したいケースがある（例: UIコンポーネント開発時のライブリロード）。
*   VS Code の Docker 拡張機能はコンテナ内の Docker デーモンのみを対象とし、ホストの Docker を操作できない。
*   開発コンテナから直接ホストの Docker CLI を利用できると、開発体験が向上する。

### 決定
*   開発コンテナ (`develop` サービス) において、Docker outside of Docker (DooD) アプローチを採用する。
*   具体的には、**開発コンテナ用の `Dockerfile.dev` を用意し、** Docker CLI (`docker-ce-cli`) をインストールし、ホストの Docker ソケット (`/var/run/docker.sock`) をコンテナ内にマウントする。
*   コンテナ内の `vscode` ユーザーがホストの `docker` グループに所属するように設定し、権限問題を回避する。**(`docker-compose.yml` の `group_add` と `.devcontainer/devcontainer.json` の `runArgs` による GID 設定)**

### 理由
*   開発コンテナからホストの Docker をシームレスに操作できるようにし、開発効率を高めるため。
*   特にフロントエンド開発において、Storybook 等のツール連携を容易にするため。

### セキュリティ上の考慮事項
*   **重要:** この設定により、開発コンテナはホストの Docker デーモンに対する完全な制御権限を持つことになる。これは `--privileged` フラグを使用せずとも、実質的に同等のリスクを伴う。
*   **リスク:** 開発コンテナが侵害された場合、ホストシステム全体が危険に晒される可能性がある。
*   **対策:**
    *   開発コンテナに使用する Docker イメージは信頼できるソース（公式イメージなど）に限定する。
    *   開発環境以外（ステージング、本番）では DooD を使用しない。
    *   開発者はこのリスクを認識し、コンテナ内での不審な操作や、信頼できないソフトウェアの実行を避ける。
*   **開発者の責任:** 開発者は DooD の利便性とリスクを理解した上で、責任を持って開発環境を使用する必要がある。 