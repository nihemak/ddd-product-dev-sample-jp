# ADR 0002: テストにおける `mockall` クレートの採用

*   **Status**: Accepted (実装済み)
*   **Date**: YYYY-MM-DD (推定)
*   **Deciders**: (不明)

## Context and Problem Statement

アプリケーション層（ユースケース）のユニットテストを実行したい。アプリケーション層はドメイン層で定義されたリポジトリインターフェース（トレイト）に依存しているため、テスト時にこれらの依存性を切り離し、テスト対象のロジックのみを検証できるようにする必要がある。

## Decision Drivers

*   アプリケーション層のロジックを独立してテストしたい。
*   テスト実行時にデータベースや外部APIなどの実際のインフラストラクチャへの依存を避けたい。
*   Rustのトレイトに基づいた依存性をモック化したい。

## Considered Options

*   **`mockall` クレート**: Rustで広く使われている高機能なモックライブラリ。マクロベースでトレイトや構造体のモックを生成できる。
*   (推測) 手動でテストダブル（スタブ、フェイク）を実装する: 柔軟性は高いが、実装とメンテナンスのコストがかかる。
*   (推測) 他のモックライブラリ（例: `mocktopus`）: それぞれ特徴が異なる。

## Decision Outcome

**テストにおける依存性のモック化のために `mockall` クレートを採用する。**

理由:
*   トレイト (`注文Repository`, `商品Repository`) のモック実装を容易に生成できる。
*   `expect_*` メソッドにより、モック対象のメソッドがどのように呼び出されるべきか（呼び出し回数、引数など）を詳細に検証できる。
*   Rustのエコシステムで広く利用されており、ドキュメントや事例が豊富である。

## Consequences

### Positive:
*   アプリケーション層のユニットテストが容易になり、テストのカバレッジと信頼性が向上した。
*   テスト実行が高速になり、外部依存がなくなった。
*   リポジトリ等の実装が未完成でも、アプリケーション層のテストを進めることが可能になった。

### Negative:
*   (推測) マクロの展開により、コンパイル時間がわずかに増加する可能性。
*   (推測) `mockall` の学習コストが若干必要。
*   (推測) モックの設定が複雑になりすぎると、テストが壊れやすくなる可能性。

## References

*   [mockall - crates.io](https://crates.io/crates/mockall)
*   `src/application.rs` のテストコード
