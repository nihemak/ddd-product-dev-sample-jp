# ADR 0002: テストにおける `mockall` クレートの採用

*   **Status**: Accepted (実装済み)
*   **Date**: 2025-04-26
*   **Deciders**: nihemak (Current maintainer)

## Context and Problem Statement

ADR 0001 で採用したオニオンアーキテクチャに基づき、Application 層のロジック（ユースケース）をユニットテストしたい。
Application 層は Domain 層で定義されたリポジトリインターフェース（トレイト）に依存している。
テスト対象のロジックのみを独立して検証するためには、テスト実行時に Infrastructure 層の具象実装（実際のデータベースアクセスなど）への依存を排除し、これらの依存性をテストダブル（モックオブジェクト）で置き換える必要がある。

## Decision Drivers

*   Application 層のビジネスロジックを独立してテスト可能にすること。
*   テスト実行時にデータベースや外部 API などの実際のインフラストラクチャへの依存を排除すること。
*   Rust のトレイト（リポジトリインターフェース）に基づいた依存性を効率的にモック化すること。

## Considered Options

*   **`mockall` クレート**: Rust エコシステムで広く使われている高機能なモックライブラリ。`#[automock]` マクロにより、トレイトや構造体のモック実装を容易に生成できる。
*   **手動でのテストダブル実装**: テスト用のスタブやフェイクを手書きで実装する。特定のシナリオに最適化できるが、ボイラープレートコードが増え、実装とメンテナンスのコストが高い。
*   **(他のモックライブラリ)**: いくつか存在するが、`mockall` が機能、ドキュメント、コミュニティサポートの面で最も成熟していると判断。

## Decision Outcome

**Application 層のテストにおける依存性モック化のために `mockall` クレートを採用する。**

理由:
*   **トレイトへの適合性**: `#[automock]` マクロを使用することで、Domain 層で定義されたリポジトリトレイトから簡単にモック実装を生成できる。
*   **強力な検証機能**: `expect_*` メソッド群により、モック対象メソッドの呼び出し回数、引数の値、順序などを詳細に設定し、テスト実行時に検証できる。
*   **エコシステムの標準**: Rust コミュニティで広く利用されており、ドキュメント、サンプル、関連情報が豊富で学習しやすい。
*   **実績**: 現在の `application.rs` のテストコードで実際に利用されており、その有効性が確認されている。

## Consequences

### Positive:
*   Application 層のユニットテスト作成が大幅に容易になった。
*   テスト実行が高速になり、外部環境（DB等）への依存がなくなった。
*   リポジトリ等の Infrastructure 層の実装が未完成でも、Application 層のロジックテストを先行して進めることが可能になった。
*   テストコードが Application 層の期待するインタラクションを明確に記述する一助となる。

### Negative:
*   `mockall` マクロの利用や `expect_*` の設定方法について、若干の学習コストが必要となる。
*   モックの設定が過度に複雑になると、テストコードの可読性が低下したり、実装の変更に対してテストが脆くなったりするリスクがある（これはモックを利用する上での一般的な注意点）。
*   マクロ展開により、コンパイル時間がわずかに増加する可能性がある（通常は無視できる範囲）。

## References

*   [mockall - crates.io](https://crates.io/crates/mockall)
*   `src/application.rs` の `#[cfg(test)]` モジュール内テストコード
