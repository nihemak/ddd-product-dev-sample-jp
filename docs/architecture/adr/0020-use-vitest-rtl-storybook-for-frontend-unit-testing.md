# ADR 0020: フロントエンドのユニットテスト戦略・ツールの選定

* **Status**: Accepted
* **Date**: 2025-05-08
* **Deciders**: (ユーザー名), AI Assistant

## Context and Problem Statement

フロントエンドアプリケーション (`frontend/`) の品質を確保し、リファクタリングや機能追加を安全に行うために、ユニットテスト及びコンポーネントテストの戦略とツールを定める必要がある。
Next.js (React) + TypeScript 環境 (ADR 0006, ADR 0019) で、`shadcn/ui` (ADR 0013) を用いて構築されるコンポーネント群に対し、効果的かつ効率的なテストを実施したい。
テストの記述しやすさ、実行速度、保守性、カバレッジ、そしてテストファーストの開発プラクティス（[`docs/PRODUCT_DEVELOPMENT_GUIDE.md`](../../PRODUCT_DEVELOPMENT_GUIDE.md) 記載）との整合性を考慮する必要がある。

## Decision Drivers

* **テスト容易性**: コンポーネントやロジックを容易にテストできること。
* **実行速度**: 開発サイクルを妨げない高速なテスト実行。
* **保守性**: テストコード自体の可読性とメンテナンスのしやすさ。
* **カバレッジ**: 主要な機能やロジックを適切にカバーできること。
* **開発者体験**: モダンで設定が容易なツールを採用すること。
* **既存ツールとの連携**: Storybook (ADR 0012) との連携可能性。
* **テストファースト**: テストを先に書く開発スタイルを支援できること。

## Considered Options

1. **Jest + React Testing Library (RTL)**:
    * Pros: 実績豊富、エコシステムが充実、RTLはReactテストのデファクトスタンダード。
    * Cons: 設定がやや複雑になる場合がある、Vitestと比較して実行速度が遅い傾向。
2. **Vitest + React Testing Library (RTL)**:
    * Pros: Viteベースで高速、JestライクなAPI、ESMネイティブサポート、設定が比較的容易。
    * Cons: Jestほどではないがエコシステムは成長中。
3. **Storybook Interaction Tests (with `@storybook/test`)**:
    * Pros: Storybook上でコンポーネントのインタラクションを視覚的にテスト可能、既存のストーリーを活用できる。
    * Cons: 単体でのカバレッジは限定的、純粋なロジックテストには不向きな場合がある。
4. **Playwright/Cypress (for Component Testing)**:
    * Pros: ブラウザ環境でより実際の動作に近いテストが可能。
    * Cons: ユニット/コンポーネントテストとしてはオーバースペックな場合があり、セットアップや実行が重い。E2Eテスト向け。

## Decision Outcome

フロントエンドのユニットテストおよびコンポーネントテスト戦略として、以下の組み合わせを採用する。

1. **主要テストフレームワーク・ライブラリ**:
    * **Vitest**: テストランナーとして採用。その高速性と設定の容易性、Jest互換のAPIを評価する。
    * **React Testing Library (RTL)**: コンポーネントのテストライブラリとして採用。ユーザーの視点に近いテスト記述を促進する。

2. **補完的なテストアプローチ**:
    * **Storybook Interaction Tests (`@storybook/test`)**: UIコンポーネントのインタラクションや状態変化をStorybook上でテストするために活用する。特に、Vitest/RTLだけでは表現しづらい、あるいは視覚的な確認と合わせてテストすることが有効な場合に用いる。

3. **テスト基本方針**:
    * **テスト対象**: 主にReactコンポーネントのレンダリング結果とインタラクション、および再利用可能なカスタムフックやユーティリティ関数内のロジック。
    * **テストの種類**:
        * ユニットテスト: 関数単体のロジックテスト。
        * コンポーネントテスト: 個々のReactコンポーネントが期待通りにレンダリングされ、ユーザーインタラクションに応じて正しく動作するかを検証する。RTLの原則に従い、実装の詳細ではなく、ユーザーから見た振る舞いをテストする。
    * **テストピラミッド/テストトロフィーの意識**: ユニットテストとコンポーネントテストでテストスイートの大部分を構成し、E2Eテスト（別途選定）への依存を減らす。
    * **カバレッジ目標**: まずは主要な機能、複雑なロジックを持つコンポーネントやフックを中心にカバレッジを確保し、徐々に拡大を目指す。具体的な数値目標は設けないが、重要な部分は網羅する。
    * **テストファースト**: 可能な範囲でテストを先に記述する開発スタイルを推奨する。

## Consequences

### Positive

* Vitestの採用により、高速なテスト実行が期待でき、開発サイクルの効率が向上する。
* RTLを用いることで、ユーザー中心のテストアプローチが促進され、リファクタリング耐性の高いテストが書ける。
* Storybook Interaction Testsを組み合わせることで、UIの振る舞いをより具体的に、かつ視覚的にテストできる。
* Jestと比較して設定がシンプルになることが期待される。

### Negative

* VitestはJestほど歴史が長くないため、特定のケースで情報や解決策が見つかりにくい可能性が僅かにある。
* 複数のテストアプローチ（Vitest/RTL と Storybook Interaction Tests）を使い分けるための若干の学習コストと判断が必要になる。

### CI/CDへの統合 (Integration with CI/CD)

* **自動実行**: フロントエンドのユニットテスト (`Vitest`) は、CIパイプラインにおいて、フロントエンド関連のコード変更があった場合に自動実行されるべきである。具体的には、`.github/workflows/ci.yml` (またはフロントエンド専用の新しいワークフローファイル) を変更し、`frontend/` ディレクトリ配下の変更をトリガーとする。
* **Storybook Interaction Tests の扱い**: Storybook Interaction Tests は、主に開発中のコンポーネント確認や、特定のUIインタラクションのデバッグに用いることを想定する。CIでの自動実行は必須としないが、将来的にE2Eテストと合わせて特定ブランチ（例: `develop`, `main`）へのマージ前に実行することを検討しても良い。
* **カバレッジレポート**: CIプロセスでテストカバレッジレポートを生成し、その結果を開発者が確認できるようにすることを推奨する（具体的なツールや閾値は別途検討）。

## ADR Template References

* [adr-template/adr-template.md at master · joelparkerhenderson/adr-template](https://github.com/joelparkerhenderson/adr-template/blob/master/template/adr-template.md)
* (プロジェクト内の既存ADR)

---
