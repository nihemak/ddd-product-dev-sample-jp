# ADR 0001: オニオンアーキテクチャの採用

*   **Status**: Accepted (実装済み)
*   **Date**: 2025-04-26
*   **Deciders**: nihemak (Current maintainer)

## Context and Problem Statement

ドメイン駆動設計 (DDD) を効果的に実践するためには、アプリケーションの中核となるドメインロジックを、UI、データベース、外部サービスといったインフラストラクチャの詳細から隔離する必要がある。
従来のレイヤードアーキテクチャでは、ドメイン層が上位または下位の層に意図せず依存してしまうリスクがあり、ビジネスルールの独立性、テスト容易性、保守性を損なう可能性がある。
そのため、関心事を明確に分離し、依存関係を一方向に制御するアーキテクチャパターンが求められる。

## Decision Drivers

*   ドメイン駆動設計 (DDD) との親和性
*   クリーンアーキテクチャ原則の適用 (関心の分離、依存性の方向制御)
*   ドメインロジックの独立性確保
*   テスト容易性 (特にドメイン層とアプリケーション層)
*   保守性・変更容易性

## Considered Options

*   **オニオンアーキテクチャ**: ドメイン層を中心に置き、依存関係が常に内側（ドメイン層）へ向かう。シンプルでバランスが良い。
*   **レイヤードアーキテクチャ**: 一般的だが、層間の依存関係が双方向になったり、ドメイン層が他の層に依存したりするリスクがある。
*   **ヘキサゴナルアーキテクチャ（ポートとアダプター）**: オニオンアーキテクチャと目的は類似するが、外部との接続点（ポートとアダプター）の定義をより重視する。オニオンに比べて若干複雑になる可能性がある。
*   **(書籍「クリーンアーキテクチャ」の同心円)**: オニオンやヘキサゴナルと基本原則は共通だが、より詳細なレイヤー定義を含む場合がある。
*   **無秩序な構造**: 関心事の分離ができず、保守性やテスト容易性が著しく低下するため不採用。

## Decision Outcome

**オニオンアーキテクチャを採用する。**

理由:
*   **DDDとの整合性**: ドメインモデルがアプリケーションの中心に位置し、他のどの層にも依存しないため、ユビキタス言語で表現されたビジネスルールを純粋な形で実装・保護することに適している。
*   **依存関係の制御**: 依存関係の方向が常に外側から内側（Infrastructure → Application → Domain）に限定される。これにより、ドメイン層とアプリケーション層はインフラストラクチャの実装詳細から完全に独立する。
*   **テスト容易性**: 依存性の逆転（Application層がDomain層で定義されたインターフェース（トレイト）に依存）と組み合わせることで、各層、特にドメイン層とアプリケーション層の単体テストが容易になる（モック利用など）。
*   **シンプルさとバランス**: ヘキサゴナルアーキテクチャや書籍「クリーンアーキテクチャ」のより厳密な定義と比較して、基本的な概念が理解しやすく、プロジェクトの規模に対してシンプルでバランスの取れた構造を提供すると判断した。
*   **実装への適合性**: 現在のコードベース (`src/domain.rs`, `src/application.rs`, `src/infrastructure.rs`, `src/main.rs`でのDI）はこのアーキテクチャパターンを反映しており、その有効性が確認されている。

## Consequences

### Positive:
*   ドメインロジックの単体テストが、インフラストラクチャを意識せずに行えるようになった。
*   インフラストラクチャ層（例: DB実装、外部APIクライアント）の差し替えや変更が、ドメイン層やアプリケーション層に影響を与えにくくなった。
*   各層の責務が明確になり、コードベースの見通しと構造的な一貫性が向上した。

### Negative:
*   レイヤー間でのデータ転送オブジェクト（DTO）の定義やマッピング処理が、シンプルなレイヤードアーキテクチャに比べて若干増加する可能性がある。(現状、大きな問題とはなっていない)
*   非常に小規模なアプリケーションやプロトタイプにおいては、構造がやや過剰になる可能性がある。

## References

*   [The Onion Architecture : part 1](https://jeffreypalermo.com/2008/07/the-onion-architecture-part-1/)
*   `docs/architecture/overview.md` (プロジェクト構成と合わせて参照)
*   (必要であれば、クリーンアーキテクチャやDDDの参考書籍を追加)
