# ADR 0021: フロントエンドのE2Eテスト戦略・ツールの選定

* **Status**: Accepted
* **Date**: 2025-05-08
* **Deciders**: (ユーザー名), AI Assistant

## Context and Problem Statement

フロントエンドアプリケーションのエンドツーエンド (E2E) での動作を保証し、主要なユーザージャーニーが期待通りに機能することを確認するために、E2Eテスト戦略とツールを定める必要がある。
ユニットテスト/コンポーネントテスト (ADR 0020) を補完し、ユーザーが実際に操作するシナリオを通じて、システムの統合的な品質を検証したい。
テストの安定性、実行速度、CIへの統合のしやすさ、デバッグの容易性を考慮する必要がある。

## Decision Drivers

* **信頼性**: 実際のユーザー操作に近い形でテストを実行し、システムの信頼性を高める。
* **安定性**: Flakyなテストを避け、安定して動作するテストスイートを構築する。
* **CI/CD統合**: CIパイプラインに組み込み、自動的にリグレッションを検出できるようにする。
* **主要シナリオのカバー**: ビジネス上重要な機能やユーザフローを網羅する。
* **開発者体験**: テストの記述やデバッグが比較的容易であること。

## Considered Options

1. **Playwright**:
    * Pros: Microsoft製、モダンな機能（自動待機、トレーシング）、クロスブラウザ対応、TypeScriptとの親和性が高い、比較的安定している。
    * Cons: Cypressと比較するとコミュニティのサイズはまだ小さいかもしれないが、急速に成長している。
2. **Cypress**:
    * Pros: 導入が容易、独自のテストランナーとダッシュボード、豊富なドキュメント。
    * Cons: Playwrightと比較すると一部の高度なブラウザ操作やクロスオリジン対応に制約があった（現在は改善傾向）。
3. **Selenium**:
    * Pros: 最も歴史があり、多言語対応、巨大なコミュニティ。
    * Cons: APIが古く、テスト記述が煩雑になりがち、実行速度や安定性の面で他のモダンなツールに劣る場合がある。

## Decision Outcome

フロントエンドのE2Eテスト戦略として、以下のツールと方針を採用する。

1. **主要E2Eテストツール**:
    * **Playwright**: その堅牢な自動待機機能、クロスブラウザサポート、優れたデバッグツール（トレーシングなど）、TypeScriptとの親和性を評価し採用する。

2. **テスト基本方針**:
    * **テスト対象**: ユーザー登録からログイン、主要機能の利用（例: プレゼント予約）、設定変更など、アプリケーションのクリティカルなユーザージャーニーに限定する。ユニットテストやコンポーネントテストでカバーできる範囲はE2Eテストの対象外とする。
    * **テストケースの設計**: 各テストケースは独立して実行可能とし、特定の状態に依存しないように心がける。テストデータは事前に準備するか、テスト内で動的に生成・クリーンアップする。
    * **セレクタ戦略**: `data-testid` 属性など、変更に強いセレクタを優先的に使用する。

3. **CI/CDへの統合**:
    * **自動実行**: トランクベース開発であることを考慮し、`main` ブランチへのコミットごとのE2Eテスト自動実行は、CI全体の実行時間を考慮して当面必須としない（ユニット/コンポーネントテストを優先）。E2Eテストスイート全体は、GitHub Actionsのスケジュール実行機能（例: 夜間バッチ）を用いて定期的にCIパイプライン上で実行し、リグレッションを検出する。将来的には、テスト対象コードに変更がない場合はスケジュール実行をスキップする最適化も検討する。開発者はローカル環境で必要に応じてE2Eテストを実行することを推奨する。
    * **実行環境**: GitHub Actions 上でヘッドレスモードのブラウザを使用して実行する。必要に応じて、テスト実行用の専用環境（Staging環境など）を準備することも検討する。
    * **レポートと通知**: テスト結果のレポート（Playwright標準のHTMLレポートなど）をCIアーティファクトとして保存し、テスト失敗時には開発チームに通知する仕組みを設ける。

4. **ローカルでの開発とデバッグ**:
    * ローカル開発環境（DevContainer内を想定）でE2Eテストを実行する際は、PlaywrightのUI Mode (`--ui` オプション) やTrace Viewerを活用し、テストの実行状況や失敗原因を視覚的に確認・デバッグすることを推奨する。これにより、ヘッドレス実行が中心となるCI環境のテスト結果も効率的に解析できる。

## Consequences

### Positive

* Playwrightの採用により、安定したE2Eテストの実行が期待できる。
* 主要なユーザージャーニーの動作保証により、リグレッションのリスクを低減できる。
* TypeScriptとの親和性が高く、型安全なテストコードを記述しやすい。
* 豊富なデバッグ機能（UI Mode, Trace Viewer）により、テスト失敗時の原因究明が容易になる。

### Negative

* E2Eテストはユニットテストに比べて実行時間が長く、CIの実行時間に影響を与える可能性がある。
* テスト環境のセットアップやテストデータの管理に手間がかかる場合がある。
* UIの変更に追随してテストコードをメンテナンスするコストが発生する。
* DevContainer環境でのPlaywright（特にブラウザバイナリや依存関係）の初回セットアップに若干の調整が必要になる可能性がある。

---
