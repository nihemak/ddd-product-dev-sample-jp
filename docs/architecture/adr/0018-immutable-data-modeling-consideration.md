# ADR 0004: イミュータブルデータモデリング導入の検討

*   **Status**: Proposed
*   **Date**: 2025-04-26
*   **Deciders**: (開発者名 or チーム名)
*   **Consulted**: (相談した人がいれば)
*   **Informed**: (関係者)

## Context and Problem Statement

現在のデータベーススキーマ (`docs/db/schema.sql`) は、予約情報 (`reservations` テーブル) などをミュータブル（変更可能）な設計としています。つまり、データの更新は既存のレコードを上書きする形で行われます。
これにより、過去のデータ状態や変更履歴が失われるため、監査証跡の確保、特定時点での状態再現、デバッグ、データ分析などの要件に対応することが難しくなる可能性があります。
イミュータブル（不変）なデータモデリング（例: 履歴テーブル、イベントソーシング）を導入することで、これらの課題を解決できる可能性がありますが、同時にデータ量の増加やクエリ・実装の複雑化といったトレードオフも存在します。

## Decision Drivers

*   将来的な監査要件への対応可能性
*   データ変更履歴の追跡と分析の必要性
*   特定時点のデータ状態再現の必要性
*   開発初期段階における実装コストと複雑性
*   データ量の増加とパフォーマンスへの影響
*   サンプルプロジェクトとしての教育的側面

## Considered Options

1.  **現状維持 (ミュータブル設計):** シンプルな実装とクエリを維持する。履歴が必要になった時点で別途対応（ログ解析など）または設計変更を検討する。
2.  **履歴テーブルパターンの導入:** メインテーブルは最新状態を保持し、変更時に別の履歴テーブルに変更前データや操作ログを記録する。比較的導入しやすい。
3.  **イベントソーシングの導入:** すべての変更をイベントとして記録し、状態はイベントから再構築する。DDD との親和性は高いが、実装・運用の複雑性が高い。
4.  **有効期間カラムの導入:** テーブルに `valid_from`, `valid_to` のようなカラムを追加し、履歴を管理する (バイテンポラルアプローチの簡易版)。

## Decision Outcome

Chosen option: **"1. 現状維持 (ミュータブル設計)"**, because:

*   MVP (Minimum Viable Product) の段階では、基本的な機能の実現と開発スピードを優先します。
*   現時点で監査や完全な履歴追跡に対する明確かつ緊急の要件はありません。
*   イミュータブル設計（特にイベントソーシング）は複雑性が高く、開発初期のコスト増加が大きいと判断しました。
*   サンプルプロジェクトとしての側面からイミュータブル設計を示す価値は認識していますが、まずは基本的なDDDとクリーンアーキテクチャの適用例を示すことを優先します。

**ただし、将来的なイミュータブル設計導入の可能性は認識しており、必要性が高まった時点で再度検討します。** その際の有力な候補としては、比較的導入しやすい「履歴テーブルパターン」が考えられます。
`created_at` および `updated_at` カラムは既に導入済みであり、ある程度の変更追跡は可能です。

## Consequences

*   **Positive:**
    *   開発初期の実装とクエリがシンプルに保たれる。
    *   ストレージコストとパフォーマンスへの懸念が当面は少ない。
*   **Negative:**
    *   完全な変更履歴は保持されない。
    *   将来的に厳密な監査要件が発生した場合、対応に追加コストがかかる。
    *   過去の特定時点でのデータ状態の再現が困難。

## Links

*   `docs/db/schema.sql` (現在のスキーマ)
*   `docs/technical_tasks.md` (関連する技術タスク) 