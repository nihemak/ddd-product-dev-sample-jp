# ADR 0003: ドメインモデルの状態を型で表現するアプローチの採用

*   **Status**: Accepted
*   **Date**: 2025-04-20
*   **Deciders**: (議論参加者)

## Context and Problem Statement

現在のドメインモデル（特にプレゼント予約）では、エンティティの状態を `enum` 型のフィールド（例: `予約ステータス`）と、`Option` 型のフィールド（例: `Option<配送伝票番号>`）の組み合わせで表現している。
この方法では、特定の状態でしか意味を持たないフィールドが存在したり、不正な状態遷移（例: 発送済みの予約をキャンセルしようとする）を実行時にチェックする必要があったりする。
より関数型スタイルを指向し、Rustの型システムの力を活用して、モデルの安全性と明確性を向上させたい。

## Decision Drivers

*   **安全性向上**: 状態遷移の正しさをコンパイル時に保証したい。
*   **明確性向上**: 特定の状態で有効な操作やデータを型レベルで明確にしたい。
*   **関数型スタイル**: 不変性や型の表現力を重視する関数型プログラミングの原則をより深く適用したい。
*   **設計と実装の一致**: ドメインのビジネスルール（状態遷移ルールなど）を型定義により直接的に反映させたい。

## Considered Options

1.  **現状維持**: `enum` による状態フィールドとロジック内での状態チェック。
    *   Pros: 実装が比較的シンプル、型の数は増えない。
    *   Cons: 実行時エラーのリスク、状態とデータの関連性が曖昧になる可能性、状態遷移ロジックが複雑化しやすい。
2.  **状態を型で表現**: エンティティの状態ごとに個別の型（または`enum`のバリアントに対応する構造体）を定義する。
    *   Pros: コンパイル時の安全性、関数の責務明確化、状態固有データの整理、設計と実装の一致。
    *   Cons: 型の増加による冗長性、状態遷移時のデータ変換実装の手間、ユビキタス言語との表現上のギャップの可能性、リポジトリ設計の複雑化の可能性。

## Decision Outcome

**選択肢2「状態を型で表現」アプローチを採用する。**

理由:
*   コンパイル時の安全性向上によるメリットが大きいと判断。実行時の状態遷移バグのリスクを大幅に削減できる。
*   関数のシグネチャで扱える状態が明確になり、コードの意図が伝わりやすくなる。
*   Rustの型システム（特に`enum`とパターンマッチング）との親和性が高い。
*   型の増加や実装の手間といったデメリットは、Rustの所有権システムやAIによる開発支援によってある程度緩和できると期待される。
*   関数型DDDの実験的な試みとしても価値があると判断。

## Consequences

### Positive:
*   ドメインモデルの不変性と安全性が向上する。
*   状態遷移に関するバグがコンパイル時に検出されやすくなる。
*   各状態で可能な操作が型レベルで明確になる。

### Negative:
*   ドメイン層の型の数が増加し、コードが冗長に見える可能性がある。
*   状態遷移のためのデータ変換ロジックの実装が必要になる。
*   ユビキタス言語で定義された用語と、実装上の型名との間にギャップが生じる可能性があるため、ドキュメント等での補足が必要。
*   リポジトリ層での永続化/読み込み戦略について、追加の検討が必要になる（ただし、ドメインモデルと永続化モデルは分離する方針）。

## Implementation Plan

*   まずは「プレゼント予約」ドメインからこのアプローチを適用する。
*   `docs/domain/ubiquitous-language.md` および `docs/domain/domain-model.md` を更新し、この設計アプローチを反映させる。
*   リポジトリのインターフェースと実装方法については、ドメイン層のリファクタリング後に別途検討・設計する。

## References

*   (関連するブログ記事や書籍があれば追記)
*   (このADRに至るまでの議論ログなどがあれば追記) 